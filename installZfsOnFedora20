#!/bin/bash
# For Fedora19,20:

# This file is expected to be called by the cloudinit subsystem,
# therefore as root.

if [[ "0" != "$(id -u)" ]] ; then
        echo "Run this program (${0}) as root."
        exit 1
fi

declare one="${1}"
declare toBuildRpms=false

Echo()
{
        echo "---> $@ <---"
}

CheckIfBuildRpms()
{
        if [[ "build" == "${one}" ]]; then
                toBuildRpms=true
        fi
}

AddZfsRepo()
{
        ${toBuildRpms} && return

        Echo "Adding ZFS repo"
        yum localinstall -y --nogpgcheck http://archive.zfsonlinux.org/fedora/zfs-release$(rpm -E %dist).noarch.rpm
}

FullUpdate()
{
        Echo "Package updates"
        yum update -y 
}

InstallMustHaves()
{
        Echo "Must-Haves"
        yum install -y screen bash-completion git mlocate
        #${toBuildRpms} && yum install -y zfs-dkms kernel-devel rpm-build which zlib-devel libuuid-devel
        if ${toBuildRpms} ; then
                Echo "Build Must-Haves"
                yum install -y zfs-dkms kernel-devel rpm-build zlib-devel libuuid-devel
        else
                Echo "NFS mount twelfth"
                Echo "Install ZFS RPMs that Jas built"
        fi
}

CreateJas()
{
        Echo "Create Jas"
        useradd jas
        #sudo sh -c "cat <<EOF >/etc/sudoers.d/91-cloud-init-users
        cat <<EOF >/etc/sudoers.d/91-cloud-init-users
# User jas has full access w/o passwd
jas ALL=(ALL) NOPASSWD:ALL
EOF
        #chmod +x /etc/sudoers.d/91-cloud-init-users

        Echo "Generate Jas' private key"
        su - jas sh -c "ssh-keygen -f ~jas/.ssh/id_rsa -N ''"

        Echo "Add Jas' key"
        cp ~fedora/.ssh/authorized_keys ~jas/.ssh
        chown jas:jas ~jas/.ssh/authorized_keys
}

SetupJas()
{
        chown jas:jas /usr/src/zfsServerBuild/setupJasHome
        mv ~jas/.bash_profile ~jas/.bash_profile.old
        cp /usr/src/zfsServerBuild/setupJasHome ~jas/.bash_profile
        ${toBuildRpms} && ln -s /usr/src/zfsServerBuild/buildZfsFromGithub ~jas
}

Reboot()
{
        Echo "Reboot in order to be in new kernel, if it was updated"
        #reboot
        shutdown -r
}

CheckIfBuildRpms
AddZfsRepo
FullUpdate
InstallMustHaves
CreateJas
SetupJas
Reboot
